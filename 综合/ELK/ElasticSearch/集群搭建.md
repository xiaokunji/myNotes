

[toc]

# 前言

本文档基于**elasticsearch 6.4.2** , **jdk 1.8** ,**三台centos6** 服务器,以下所有操作均在`jht`用户下完成,以`10.10.204.167`为主服务器

>  不要使用root账号安装!!!  使用额外账号安装,例如:`jht`

[中文官网](https://www.elastic.co/cn/)



# 1. 准备

1. **安装jdk**
2. **下载elasticsearch安装包并解压**

`wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.4.2.tar.gz && tar-xzvf elasticsearch-6.4.2.tar.gz `

[官网下载地址](https://www.elastic.co/cn/downloads/past-releases/elasticsearch-6-4-2)

# 2. 安装

3. **修改配置**

   进入`elasticsearch-6.4.2/config` ,修改 `elasticsearch.yml` 文件(已删除多余注释)

   ```properties
   # 集群名称,各节点应保持一致
   cluster.name: bdp_es
   
   # 节点名称,每台服务器应不一样
   node.name: node167
   #当主节点挂了后，是否有资格被竞选为主节点
   node.master: true
   #是否为数据节点（能否存储数据）
   node.data: true
   
   path.data: /opt/soft/es-cdh/elasticsearch-6.4.2/data
   
   path.logs: /opt/soft/es-cdh/elasticsearch-6.4.2/logs
   
   bootstrap.system_call_filter: false
   
   
   network.host: 0.0.0.0
   
   http.port: 9200
   transport.tcp.port: 9300
   
   # 集群配置
   discovery.zen.ping.unicast.hosts: ["10.10.204.166:9300", "10.10.204.167:9300","10.10.204.165:9300"]
   
   #以下三个配置的意思是：每隔30秒向主节点发送一次心跳监测，120秒之内如果没有回应，则算超时
   ##连续超时6次，则认为主节点已经挂了
   discovery.zen.fd.ping_timeout: 120s
   discovery.zen.fd.ping_retries: 6
   discovery.zen.fd.ping_interval: 30s
   ##ping节点的响应时间
   client.transport.ping_timeout : 60s
   # 至少几个节点
   discovery.zen.minimum_master_nodes: 2
   
   ```

> 创建 数据和日志目录
>
> `mkdir -p /opt/soft/es-cdh/elasticsearch-6.4.2/data`
>
> `mkdir -p /opt/soft/es-cdh/elasticsearch-6.4.2/logs`



4. **修改系统配置**
- 编辑`/etc/security/limits.conf`文件


   ```properties
   # 配置解释见limits.conf
   # 追加如下内容,如已存在则更新
   * soft nofile 65536
   * hard nofile 65536
   * soft nproc 16384
   * hard nproc 16384
   ```

- 编辑`/etc/sysctl.conf`

   ```properties
   # 追加如下内容,如已存在则更新
   vm.max_map_count = 655360
   ```

- 修改完系统配置后,需要退出当前回话,并**重新登录才能生效**

   


   > 检查防火墙,必要时打开9200和9300端口
   >
   > sudo vim /etc/sysconfig/iptables
   >
   >  
   >
   > ```
   > -A INPUT -m state --state NEW -m tcp -p tcp --dport 9200 -j ACCEPT
   > 
   > -A INPUT -m state --state NEW -m tcp -p tcp --dport 9300 -j ACCEPT
   > ```
   >
   > #重启防火墙，检查防火墙重启是否成功
   >
   > service iptables restart

   

   

> 启动时如果仍报错,就继续如下编辑操作(没有则新建)
>
> 1. 编辑 `/etc/security/limits.d/90-nproc.conf`
>
>    ```
>    * soft nproc 204800
>    * hard nproc 204800
>    ```
>
> 2. 编辑`/etc/security/limits.d/def.conf`
>
>    ```
>    * soft nofile 204800
>    * hard nofile 204800
>    ```



5. **启动单机并检测**

   进入es的bin目录,执行 

   ```sh
   ./elasticsearch
   ```

   出现**一直在等待其他节点**相关日志即成功(因为至少启动两个节点)

   

6. **搭建其他节点**

   1. 将所有文件复制到其他服务器上

   `scp -r elasticsearch-6.4.2 jht@10.10.204.166:/opt/soft/es-cdh`

   `scp -r elasticsearch-6.4.2 jht@10.10.204.165:/opt/soft/es-cdh`

   2. **修改`elasticsearch.yml`文件,保证节点名不一样**

      

7. **启动三台服务器并验证**

   **使用elasticsearch head插件验证**

   连接集群中任意一台均可,能连接上即搭建成功



# 3. 实战

以`10.101.204.167`为主服务器,在其上写了管理脚本,脚本路径: `/home/jht/runShell/esManage.sh`

```sh
#!/bin/bash

# 简易es管理脚本,可一键启动和停止
# 可改进: 脚本健壮性(如:可重复启动); 命令提取为变量等

start(){
    echo "启动es集群....."
    esPath=/opt/soft/es-cdh/elasticsearch-6.4.2/bin
    
	# ${esPath}/elasticsearch  -d  // 表示后台启动
    nohup ${esPath}/elasticsearch   > /home/jht/runShell/logs/es.log 2>&1 &

    ssh jht@10.10.204.166 "source /etc/profile; nohup ${esPath}/elasticsearch  > /home/jht/runShell/logs/es.log 2>&1 &"
    ssh jht@10.10.204.165 "source /etc/profile; nohup ${esPath}/elasticsearch  > /home/jht/runShell/logs/es.log 2>&1 &"
}

stop(){
  echo "关闭es集群....."

  pgrep -f  Elasticsearch | xargs kill -9

  ssh jht@10.10.204.166 " pgrep -f  Elasticsearch | xargs kill -9"
  ssh jht@10.10.204.165 " pgrep -f  Elasticsearch | xargs kill -9"

}


case "$1" in
   "start")
      start  ;;
   "stop")
      stop   ;;
   *)
      echo " 允许的参数(必选): { start| stop } "    ;;
esac

```



**启动es集群** : `/home/jht/runShell/esManage.sh  start`

**关闭es集群**:  `/home/jht/runShell/esManage.sh  stop`



> 参考文章:
>
> [集群搭建](https://blog.csdn.net/qq_35608313/article/details/90692096)
>
> [环境配置](https://blog.csdn.net/xzw_123/article/details/46878459)
>
> [安装问题集锦](https://www.jianshu.com/p/fce1474dc6e7)
>
> [远程kill问题](https://www.zhihu.com/question/305084015)

