[toc]

# Redis的单线程指什么

Redis 单线程主要指的是网络IO和键值对读写是由一个线程来完成的，Redis在<u>处理客户端的请求</u>的时候包括获取(Socket)，解析，执行，内容返回(Socket写)等由一个顺序串行的主线程处理，这即为单线程 

但Redis的其它功能，比如持久化，异步删除，集群数据同步等等，都是由额外的线程执行的，是多线程 

**即Redis工作线程是单线程的，但是，整个Redis来说是多线程的**



# Redis单线程为什么很快

1、基于内存操作：Redis的所有数据都存在内存中，因此所有的运算都是内存级别

2、数据结构简单：Redis的数据结构简单，查找和操作时间大部分时间复杂度是O(1)

3、多路复用和非阻塞：Redis使用多路复用功能来监听多个Socket链接客服端，这样可以一个线程处理多个请求，减少线程切换带来的开销，同时也避免了IO阻塞操作

4、避免上下文切换：因为是单线程模型，因此避免了多线程切换和多线程竞争，减少时间和性能的消耗



[Redis系列第一讲：Redis是单线程吗 - 掘金 (juejin.cn)](https://juejin.cn/post/7031953350157402148)



# 谈谈redis的对象机制（redisObject)

Redis的5种基础数据类型，在底层是采用对象机制实现的。

Redis的每种对象其实都由对象结构(redisObject) 与 对应编码的数据结构组合而成，而每种对象类型对应若干编码方式，不同的编码方式所对应的底层数据结构是不同的。

redisObject 是 Redis 类型系统的核心, 数据库中的每个键、值, 以及 Redis 本身处理的参数, 都表示为这种数据类型。

![image-20220727113818732](.\面试.assets\image-20220727113818732.png)

[Redis相关知识----对象机制_小舟~的博客-CSDN博客](https://blog.csdn.net/CarrotZsy/article/details/115964515)



# redis 优化措施

1. 避免大key的存在

2. 设置合理的淘汰策略

   > 内存尽可能大; 淘汰策略改为随机淘汰，随机淘汰比 LRU 要快很多（视业务情况调整）

3. 谨慎fork操作带来的阻塞

   > 控制 Redis 实例的内存：尽量在 10G 以下，执行 fork 的耗时与实例大小有关，实例越大，耗时越久

4. 关闭操作系统的内存大页

   > 应用在申请内存时,linux会给一个完整的内存页大小, 申请的多了, 分配内存也就大了 , 耗时也就长了
   >
   > 对于 Redis 这种对性能和延迟极其敏感的数据库来说，我们希望 Redis 在每次申请内存时，耗时尽量短

5. 开启AOF后设置 重写时不刷盘

   > ```bash
   > # AOF rewrite 期间，AOF 后台子线程不进行刷盘操作
   > # 相当于在这期间，临时把 appendfsync 设置为了 none
   > no-appendfsync-on-rewrite yes
   > ```
   >
   > 建议使用 固态硬盘, 加快数据落磁盘

   

6. 关闭swap 内存

   > 操作系统为了缓解内存不足对应用程序的影响，允许把一部分内存中的数据换到磁盘上，以达到应用程序对内存使用的缓冲，这些内存数据被换到磁盘上的区域，就是 Swap。

   [Redis进阶 - 性能调优：Redis性能调优详解 | Java 全栈知识体系 (pdai.tech)](https://pdai.tech/md/db/nosql-redis/db-redis-x-performance.html)

   
   



# 热key的处理

1. 利用二级缓存

   将热key加载到jvm中, 利用本地缓存抗住

2. 备份热key

   将热key多备份几份,用后缀区分,  这样请求就会分发到不同的key上了



**检测热key**

1. 经验预估, 比如秒杀key
2. 客户端收集并统计
3. redis 自带的命令 , `monitor`和`hotkeys` 但都有性能问题

[【原创】谈谈redis的热key问题如何解决 - 孤独烟 - 博客园 (cnblogs.com)](https://www.cnblogs.com/rjzheng/p/10874537.html)







